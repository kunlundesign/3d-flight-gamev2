import{V as k,ad as Ke,ae as _e,af as Ce,ag as ke,Y as $e,ah as Ye,ai as qe,aj as Xe,D as Te,ak as je,al as ge,am as S,H as c,an as _,ao as w,ap as D,X as z,aq as ce,C as le,ab as Ie,ar as Ee,as as Ae,y,at as H,Z as se,au as Ze,av as Je,aw as pe,ax as Me,A as $,z as Se,ay as Qe,k as et}from"./three-C1hlX028.js";import{m as tt,B as ot,G as Le}from"./game-By5lhz7D.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function o(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(a){if(a.ep)return;a.ep=!0;const s=o(a);fetch(a.href,s)}})();class at{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.aircraft=null,this.loadedModel=null,this.playerPosition=new k(0,50,0),this.playerVelocity=new k(0,0,0),this.playerSpeed=60,this.playerHealth=30,this.playerMaxHealth=30,this.currentViewIndex=0,this.viewModes=[{name:"Chase View",offset:new k(0,30,-80),description:"Default chase camera"},{name:"Northeast View",offset:new k(100,60,100),description:"Northeast isometric view"},{name:"Northwest View",offset:new k(-100,60,100),description:"Northwest isometric view"},{name:"Tactical View",offset:new k(0,200,-50),description:"Top-down tactical view"}],this.inputState={pitch:0,yaw:0,roll:0,speed:.6,keys:new Set},this.lastWrapMessageTime=0,this.modelAnimationMixer=null,this.modelAnimations=[],this.activeAnimations=[],this.animationClock=new Ke,this.terrain=[],this.clouds=[],this.sceneType="grassland";const e=window.location.hash.replace("#","").toLowerCase();["snow","desert","ocean","grassland","default"].includes(e)&&(this.sceneType=e==="default"?"grassland":e||"grassland"),this.environmentConfig=this.getEnvironmentConfig(this.sceneType),this.tanks=[],this.warships=[],this.raycaster=new _e,this.isFiring=!1,this.lastShotTime=0,this.fireInterval=.08,this.bullets=[],this.enemyBullets=[],this.muzzleFlashes=[],this.gunBarrels=[],this.tempVec=new k,this.forwardVec=new k(0,0,1),this.playerName=null,this.scoreData={players:{}},this.localStorageKey="skywarriors_scores_v1",this.sessionKills={tank:0,ship:0},this.ensurePlayerName(),this.loadScores(),this.registerPlayerIfNeeded(),this.updateScoreboardUI(),this.init()}updatePlayerHealthDisplay(){const e=document.getElementById("playerHealthDisplay"),o=document.getElementById("playerHealthValue");e&&o&&(e.style.display="block",o.textContent=Math.max(0,Math.round(this.playerHealth)),this.playerHealth<=10?e.classList.add("low-health"):e.classList.remove("low-health"))}init(){this.setupScene(),this.setupLighting(),this.createTerrain(),this.createClouds(),this.createDefaultAircraft(),this.createNoseCannons(),this.setupFileUpload(),this.setupKeyboardControls(),this.setupMouseControls(),this.setupSceneSwitcher(),this.hideLoadingScreen(),this.gameLoop()}setupScene(){this.scene=new Ce;const o={default:8900331,snow:14412277,desert:14860923,ocean:7320319}[this.sceneType]||8900331;this.scene.fog=new ke(o,100,2e3),this.camera=new $e(75,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,100,200),this.renderer=new Ye({antialias:!0,alpha:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(o,1),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=qe,document.getElementById("gameContainer").appendChild(this.renderer.domElement),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)})}setupLighting(){const e=new Xe(16777215,.6);this.scene.add(e);const o=new Te(16777215,1);o.position.set(100,300,100),o.castShadow=!0,o.shadow.mapSize.width=4096,o.shadow.mapSize.height=4096,o.shadow.camera.near=.5,o.shadow.camera.far=2e3,o.shadow.camera.left=-1e3,o.shadow.camera.right=1e3,o.shadow.camera.top=1e3,o.shadow.camera.bottom=-1e3,o.shadow.bias=-1e-4,this.scene.add(o);const t=new je(8900331,6130234,.4);t.position.set(0,500,0),this.scene.add(t),[{pos:[200,100,0],intensity:.2},{pos:[-200,100,0],intensity:.2},{pos:[0,100,200],intensity:.15},{pos:[0,100,-200],intensity:.15}].forEach(s=>{const n=new Te(16777215,s.intensity);n.position.set(s.pos[0],s.pos[1],s.pos[2]),n.castShadow=!1,this.scene.add(n)})}createTerrain(){const e=new ge(8e3,8e3,150,150);let o=6130234;this.sceneType==="snow"?o=15922937:this.sceneType==="desert"?o=14270864:this.sceneType==="ocean"&&(o=1789834);const t=new S({color:o,wireframe:!1}),a=e.attributes.position.array;for(let n=0;n<a.length;n+=3)a[n+2]=Math.random()*15-7;e.attributes.position.needsUpdate=!0,e.computeVertexNormals();const s=new c(e,t);if(s.rotation.x=-Math.PI/2,s.position.y=-50,s.receiveShadow=!0,this.scene.add(s),this.ground=s,this.sceneType==="snow")this.createSnowMountains(),this.createConiferForests(),this.createLakes(12442098,!0);else if(this.sceneType==="desert")this.createDesertDunes(),this.createPyramids(),this.createDesertPlants();else if(this.sceneType==="ocean")this.createOceanSurface(),this.createSmallIslands(),this.createWarships(6);else{this.createMountainRanges(),this.createTrees(),this.createLakes(),this.createSoilPatches(this.environmentConfig.soilPatchCount),this.environmentConfig.rockCount>0&&this.createRocks(this.environmentConfig.rockCount),this.createGrassPatches(this.environmentConfig.grassPatchCount);for(let n=0;n<this.environmentConfig.bushClusterCount;n++)this.createBushCluster((Math.random()-.5)*6500,(Math.random()-.5)*6500,6+Math.random()*8);if(this.environmentConfig.birdFlocks>0)for(let n=0;n<this.environmentConfig.birdFlocks;n++)this.createBirdFlock()}this.sceneType!=="ocean"&&this.createTanks(30)}getEnvironmentConfig(e){switch(e==="default"&&(e="grassland"),e){case"snow":return{treeDensityMultiplier:1.8,rockCount:10,grassPatchCount:40,bushClusterCount:20,birdFlocks:0,soilPatchCount:20};case"desert":return{treeDensityMultiplier:.4,rockCount:5,grassPatchCount:0,bushClusterCount:5,birdFlocks:0,soilPatchCount:10};case"ocean":return{treeDensityMultiplier:0,rockCount:0,grassPatchCount:0,bushClusterCount:0,birdFlocks:0,soilPatchCount:0};case"grassland":default:return{treeDensityMultiplier:2.8,rockCount:0,grassPatchCount:180,bushClusterCount:70,birdFlocks:0,soilPatchCount:120}}}createSnowMountains(){this.createMountainRange(-2500,-1500,7,"high",14213094),this.createMountainRange(2600,2100,6,"high",13621470);for(let e=0;e<20;e++)this.createSingleMountain((Math.random()-.5)*7e3,(Math.random()-.5)*7e3,"random",14739436)}createConiferForests(){for(let e=0;e<140;e++)this.createTree((Math.random()-.5)*6500,(Math.random()-.5)*6500,"pine")}createDesertDunes(){for(let e=0;e<40;e++){const o=new _(120+Math.random()*180,30+Math.random()*25,12);o.scale(2.5,.4,1.2);const t=new S({color:14930593}),a=new c(o,t);a.position.set((Math.random()-.5)*7e3,-35,(Math.random()-.5)*7e3),a.rotation.y=Math.random()*Math.PI,a.castShadow=!0,a.receiveShadow=!0,this.scene.add(a)}}createPyramids(){const e=new S({color:13217893});for(let o=0;o<5;o++){const t=200+Math.random()*160,a=new _(t/2,t/1.2,4),s=new c(a,e);s.rotation.y=Math.PI/4,s.position.set((Math.random()-.5)*6e3,-50+t/2.4,(Math.random()-.5)*6e3),s.castShadow=!0,s.receiveShadow=!0,this.scene.add(s)}}createDesertPlants(){for(let e=0;e<60;e++){const o=new c(new w(.5,.7,18,6),new S({color:9132587})),t=new c(new D(5,8,6),new S({color:13945226}));t.position.y=10;const a=new z;a.add(o),a.add(t),a.position.set((Math.random()-.5)*7e3,-50,(Math.random()-.5)*7e3),this.scene.add(a)}for(let e=0;e<120;e++){const o=6+Math.random()*10,t=new c(new w(.7,.9,o,6),new S({color:3108667})),a=new z;if(a.add(t),Math.random()>.5){const s=new c(new w(.4,.5,o*.5,6),t.material);s.position.y=o*.4,s.position.x=.9,s.rotation.z=Math.PI/10,a.add(s)}a.position.set((Math.random()-.5)*7e3,-50,(Math.random()-.5)*7e3),this.scene.add(a)}for(let e=0;e<160;e++){const o=1.5+Math.random()*2.5,t=new c(new D(o,8,6),new S({color:14258734}));t.position.set((Math.random()-.5)*7200,-50+o*.4,(Math.random()-.5)*7200),t.castShadow=!0,this.scene.add(t)}}createOceanSurface(){const e=new c(new ge(8e3,8e3,50,50),new S({color:3112401,transparent:!0,opacity:.95}));e.rotation.x=-Math.PI/2,e.position.y=-40,e.receiveShadow=!0,this.scene.add(e)}createSmallIslands(){for(let e=0;e<18;e++){const o=120+Math.random()*140,t=new ce(o,24),a=new S({color:13156487}),s=new c(t,a);s.rotation.x=-Math.PI/2,s.position.set((Math.random()-.5)*6e3,-49.5,(Math.random()-.5)*6e3),this.scene.add(s);for(let n=0;n<5;n++)this.createTree(s.position.x+(Math.random()-.5)*o,s.position.z+(Math.random()-.5)*o,"palm")}}createMountainRanges(){this.createMountainRange(-3e3,-2e3,8,"high",9139029),this.createMountainRange(2500,2200,6,"high",6908265),this.createMountainRange(-1500,2800,5,"medium",10506797),this.createMountainRange(3200,-1200,7,"medium",9139029),this.createMountainRange(0,3500,4,"low",10145074),this.createMountainRange(-2800,1e3,5,"low",2263842);for(let e=0;e<15;e++){const o=(Math.random()-.5)*7e3,t=(Math.random()-.5)*7e3;this.createSingleMountain(o,t,"random")}}createMountainRange(e,o,t,a,s){for(let n=0;n<t;n++){const i=n/t*Math.PI*2,r=200+Math.random()*300,l=e+Math.cos(i)*r,d=o+Math.sin(i)*r;this.createSingleMountain(l,d,a,s)}}createSingleMountain(e,o,t,a){let s,n,i,r;switch(t){case"high":s=120+Math.random()*110,n=50+Math.random()*40,i=Math.random()<.2?"ridge":Math.random()<.4?"mesa":"cone",r=a||8021328;break;case"medium":s=70+Math.random()*60,n=40+Math.random()*30,i=Math.random()<.3?"pyramid":Math.random()<.55?"dome":"cone",r=a||10248755;break;case"low":s=30+Math.random()*45,n=32+Math.random()*22,i=Math.random()<.5?"dome":"ridge",r=a||7319099;break;default:return this.createSingleMountain(e,o,["high","medium","low"][Math.floor(Math.random()*3)])}Math.random()<.08&&(i="crater");let l;switch(i){case"cone":l=new _(n,s,10+Math.floor(Math.random()*5));break;case"pyramid":l=new _(n,s,4);break;case"dome":l=new D(n,12,8,0,Math.PI*2,0,Math.PI/2),l.scale(1,s/n,1);break;case"mesa":{const T=new w(n*.8,n,s*.65,10),v=new w(n*.55,n*.6,s*.15,10);v.translate(0,s*.4,0),l=ot?tt([T,v]):T;break}case"ridge":l=new _(n,s,6),l.scale(1.8,1,.6);break;case"crater":l=new w(n*1.3,n*1.4,s*.5,24,1,!0);break}const d=l.attributes.position;for(let T=0;T<d.count;T++){const v=d.getX(T),V=d.getY(T),L=d.getZ(T),O=(Math.sin(v*.15)+Math.sin(L*.18))*.6+(Math.random()-.5)*.9;d.setY(T,V+O*2),d.setX(T,v+(Math.random()-.5)*.8),d.setZ(T,L+(Math.random()-.5)*.8)}d.needsUpdate=!0,l.computeVertexNormals();const h=se.clamp((s-40)/140,0,1),m=new le(r),u=new le().setHSL(.08+.1*h,.35,.25+.25*h);m.lerp(u,.4),l.computeBoundingBox();const p=l.boundingBox,C=-50-p.min.y,R=new S({color:m}),A=new c(l,R);if(A.position.set(e,C,o),A.rotation.y=Math.random()*Math.PI*2,A.castShadow=!0,A.receiveShadow=!0,A.userData.type="mountain",this.scene.add(A),s>110){const T=s*.25,v=new c(new _(n*.35,T,10),new S({color:16119800})),V=A.position.y+p.max.y;v.position.set(e,V-s*.12,o),v.castShadow=!1,v.receiveShadow=!0,this.scene.add(v)}}createClouds(){for(let e=0;e<60;e++){const o=new D(20+Math.random()*30,8,6),t=new S({color:16777215,transparent:!0,opacity:.7}),a=new c(o,t);a.position.set((Math.random()-.5)*6e3,100+Math.random()*200,(Math.random()-.5)*6e3),a.scale.set(1+Math.random()*.5,.3+Math.random()*.3,1+Math.random()*.5),this.clouds.push(a),this.scene.add(a)}}createDefaultAircraft(){console.log("Attempting to load red-plane.glb...");const e=new Le,o=window.__APP_BASE__||"/",t=o+"models/red-plane.glb";console.log("Loading from path:",t," baseUrl:",o," (runtime)"),e.load(t,a=>{console.log("✅ Successfully loaded red-plane.glb");const s=a.scene,n=46,r=new Ie().setFromObject(s).getSize(new k),l=Math.max(r.x,r.y,r.z),d=n/l;s.scale.set(d,d,d),console.log(`Red plane scaled: ${l.toFixed(2)} → ${n} units (${d.toFixed(3)}x)`),this.modelAnimations=a.animations,this.modelAnimationMixer=null,this.activeAnimations=[],a.animations&&a.animations.length>0&&(this.modelAnimationMixer=new Ee(s),console.log(`Red plane: Found ${a.animations.length} animations:`,a.animations.map(h=>h.name)),a.animations.forEach((h,m)=>{const u=this.modelAnimationMixer.clipAction(h);u.setLoop(Ae),u.clampWhenFinished=!1;const p=h.name.toLowerCase();p.includes("propeller")||p.includes("rotor")||p.includes("engine")||p.includes("fan")||p.includes("spin")?(u.timeScale=2,u.play(),this.activeAnimations.push(u),console.log(`Auto-playing fast animation: ${h.name}`)):(u.timeScale=1,u.play(),this.activeAnimations.push(u),console.log(`Auto-playing animation: ${h.name}`))})),s.traverse(h=>{h.isMesh&&(h.castShadow=!0,h.receiveShadow=!0,h.material&&(Array.isArray(h.material)?h.material.forEach(m=>{this.enhanceMaterial(m)}):this.enhanceMaterial(h.material)))}),s.position.copy(this.playerPosition),this.loadedModel=s,this.aircraft=s,s.userData.aircraftType="red-plane-glb",this.scene.add(s),console.log("✅ RED PLANE GLB ADDED TO SCENE at position:",s.position),console.log("✅ Aircraft type set to:",s.userData.aircraftType),this.createNoseCannons(),console.log("Red plane loaded as default aircraft")},void 0,a=>{console.error("❌ GLTFLoader error:",a),console.log("🔄 Falling back to built-in aircraft"),this.createBuiltInAircraft()})}createBuiltInAircraft(){const e=new z,o=new y({color:13882323,metalness:.9,roughness:.35,envMapIntensity:1}),t=new y({color:14764594,metalness:.05,roughness:.85});new y({color:8900331,transparent:!0,opacity:.25,metalness:0,roughness:0});const a=new y({color:6184542,metalness:.95,roughness:.4}),s=new w(1.4,.7,16,16),n=new c(s,o);n.rotation.x=Math.PI/2,n.position.set(0,0,0),n.castShadow=!0,n.receiveShadow=!0,e.add(n);const i=new _(1.4,3,16),r=new c(i,o);r.position.set(0,0,10),r.rotation.x=Math.PI/2,r.castShadow=!0,r.receiveShadow=!0,e.add(r);const l=new w(1.6,1.4,3,12),d=new c(l,a);d.rotation.x=Math.PI/2,d.position.set(0,0,6.5),d.castShadow=!0,e.add(d);const h=new H(4,.8,4),m=new c(h,t);m.position.set(0,-.2,-1),m.castShadow=!0,e.add(m);for(let f=-1;f<=1;f+=2)for(let x=1;x<=6;x++){const G=4-x*.4,F=.8-x*.08,E=new H(G,F,3),P=new c(E,t);P.position.set(f*x*1.8,-.2-x*.02,-1),P.castShadow=!0,e.add(P)}const u=new H(1,.4,2);for(let f=-1;f<=1;f+=2){const x=new c(u,t);x.position.set(f*10.8,-.3,-1),x.castShadow=!0,e.add(x)}const p=new w(.6,.4,4,8),g=new c(p,o);g.rotation.x=Math.PI/2,g.position.set(0,0,-8),g.castShadow=!0,e.add(g),(function(){const f=new z,x=.4,G=6,F=4,E=.8,P=4,j=F*x,ee=E*.6*x,ae=P*.55,Ve=new H(j,ee,ae),fe=new c(Ve,t);fe.position.set(0,0,-10),fe.castShadow=!0,f.add(fe);for(let re=-1;re<=1;re+=2){for(let te=1;te<=G;te++){const ve=(F-te*.4)*x,Pe=(E-te*.08)*.6*x,Ue=(P-te*.35)*.55;if(ve<=.2||Pe<=.02)continue;const We=new H(ve,Pe,Math.max(Ue,.6)),me=new c(We,t);me.position.set(re*(te*1.8*x),-.02-te*.01,-10),me.rotation.y=re*se.degToRad(1+te*.6),me.castShadow=!0,f.add(me)}const Oe=new H(.9*x,.35*x,1.2*.55),ye=new c(Oe,t);ye.position.set(re*(G*1.8*x+.3),-.1,-10),ye.castShadow=!0,f.add(ye)}e.add(f)})(),(function(){const E=new Ze;E.moveTo(.32,0),E.lineTo(3-.32,0),E.quadraticCurveTo(3,0,3,.32),E.lineTo(.32,4.2-.32),E.quadraticCurveTo(0,4.2,0,4.2-.32),E.lineTo(0,.32),E.quadraticCurveTo(0,0,.32,0),E.closePath();const P=new Je(E,{depth:.18,bevelEnabled:!1});P.rotateY(Math.PI/2),P.computeBoundingBox();let j=P.boundingBox;P.translate(0,-j.min.y,0),P.computeBoundingBox(),j=P.boundingBox,Math.abs(j.min.z)>1e-5&&P.translate(0,0,-j.min.z),P.computeBoundingBox(),j=P.boundingBox;const ee=-(j.min.x+j.max.x)/2;P.translate(ee,0,0);const ae=new c(P,t);ae.position.set(0,0,-10),ae.scale.z=-1,ae.updateMatrix(),ae.castShadow=!0,e.add(ae)})();const C=new _(.8,1.5,12),R=new y({color:0,metalness:.95,roughness:.25}),A=new c(C,R);A.position.set(0,0,12),A.rotation.x=Math.PI/2,A.castShadow=!0,e.add(A);const T=new w(.6,.6,.6,12),v=new c(T,R);v.position.set(0,0,11),v.rotation.x=Math.PI/2,v.castShadow=!0,e.add(v);const V=new z,L=new y({color:0,metalness:.9,roughness:.35});for(let f=0;f<3;f++){const x=new H(.3,8,.15),G=new c(x,L);G.rotation.z=f*2*Math.PI/3,G.castShadow=!0,V.add(G);const F=new D(.2,8,4),E=new c(F,L);E.position.set(0,4,0),E.rotation.z=f*2*Math.PI/3,G.add(E)}V.position.set(0,0,11.3),e.add(V),this.propeller=V;const O=new y({color:4210752,metalness:.8,roughness:.3});for(let f=-1;f<=1;f+=2){const x=new w(.06,.09,2.2,8),G=new c(x,O);G.position.set(f*1.8,-1.8,0),G.castShadow=!0,e.add(G);const F=new w(.65,.65,.3,16),E=new y({color:1710618,roughness:.9}),P=new c(F,E);P.position.set(f*1.8,-2.9,0),P.rotation.z=Math.PI/2,P.castShadow=!0,e.add(P);const j=new w(.5,.5,.32,16),ee=new c(j,O);ee.position.set(f*1.8,-2.9,0),ee.rotation.z=Math.PI/2,ee.castShadow=!0,e.add(ee)}const Y=new z,W=new c(new w(.05,.08,1.5,8),O);W.rotation.z=0,W.position.set(0,-.2,-8.6),W.castShadow=!0,Y.add(W);const q=new c(new H(.2,.2,.4),O);q.position.set(0,-1,-9),q.castShadow=!0,Y.add(q);const b=new w(.35,.35,.25,14),N=new c(b,new y({color:1710618,roughness:.9}));N.rotation.x=0,N.rotation.z=Math.PI/2,N.position.set(0,-1.1,-9),N.castShadow=!0,Y.add(N),e.add(Y);const B=1.35,I=new D(B,32,20,0,Math.PI*2,0,Math.PI/2),Z=new y({color:10077912,metalness:0,roughness:.05,transparent:!0,opacity:.28,depthWrite:!1}),M=new z,K=new c(I,Z);K.castShadow=!1,K.receiveShadow=!1,M.add(K);const U=new y({color:2961716,metalness:.65,roughness:.35}),X=.04,J=12,he=48,ne=new c(new pe(B*.995,X,J,he),U);ne.rotation.x=Math.PI/2,ne.castShadow=!0,M.add(ne);const ie=new c(new pe(B,X*.75,J,he),U);ie.castShadow=!0,M.add(ie);const Q=new c(new pe(B,X*.75,J,he),U);Q.rotation.z=Math.PI/2,Q.castShadow=!0,M.add(Q);const oe=new c(new H(X*.9,X*.9,B*2*.92),U);oe.position.y=B*.72,oe.castShadow=!0,M.add(oe),M.position.set(0,.68,.2),M.rotation.y=Math.PI/2,e.add(M);const ze=new H(.8,.4,1.2),De=new y({color:4868682,roughness:.8}),ue=new c(ze,De);ue.position.set(0,.1,.5),ue.castShadow=!0,e.add(ue);const Ge=new w(.05,.05,.6,8),we=new c(Ge,a);we.position.set(0,.4,1),we.castShadow=!0,e.add(we);const Re=new H(1.4,.6,.08),Ne=new y({color:2763306,roughness:.6,metalness:.3}),de=new c(Re,Ne);de.position.set(0,.5,2),de.rotation.x=-Math.PI/6,de.castShadow=!0,e.add(de);for(let f=-1;f<=1;f+=2){const x=new D(.12,8,6),G=new y({color:f>0?65280:16711680,emissive:f>0?17408:4456448,emissiveIntensity:.5,metalness:.1,roughness:.2}),F=new c(x,G);F.position.set(f*11,0,-1),e.add(F)}const Fe=new D(.08,8,6),He=new y({color:16777215,emissive:2236962,emissiveIntensity:.3,metalness:.1,roughness:.2}),xe=new c(Fe,He);xe.position.set(0,1,-12),e.add(xe);for(let f=0;f<6;f++){const x=new w(.12,.18,1.2,8),G=new y({color:2763306,metalness:.6,roughness:.7,emissive:2232576,emissiveIntensity:.1}),F=new c(x,G),E=f/6*Math.PI*2,P=1.2;F.position.set(Math.cos(E)*P,Math.sin(E)*P,5),F.rotation.x=Math.PI/2,F.castShadow=!0,e.add(F)}e.position.copy(this.playerPosition),e.scale.set(2.16,2.16,2.16),this.loadedModel=null,this.aircraft=e,e.userData.aircraftType="built-in-aircraft",this.scene.add(this.aircraft),console.log("⚠️ BUILT-IN AIRCRAFT CREATED as fallback"),console.log("⚠️ Aircraft type set to:",e.userData.aircraftType);const be=this.aircraft.getObjectByName("NoseCannons");be&&this.aircraft.remove(be),this.gunBarrels=[],this.createNoseCannons(),console.log("Built-in aircraft loaded as fallback")}createNoseCannons(){if(!this.aircraft||this.aircraft.getObjectByName("NoseCannons"))return;const e=new z;e.name="NoseCannons";const o=!!this.loadedModel,t=new y({color:2894892,metalness:.85,roughness:.25,transparent:o,opacity:o?0:1}),a=new w(.12,.12,1.6,12);this.gunBarrels=[];for(let n of[-1,1]){const i=new c(a,t);i.rotation.x=Math.PI/2,i.position.set(n*.6,-.15,7.2),i.castShadow=!o,e.add(i),this.gunBarrels.push(i)}const s=new pe(.28,.045,6,16);for(let n of[-1,1]){const i=new c(s,new y({color:5592405,metalness:.6,roughness:.4,transparent:o,opacity:o?0:1}));i.rotation.x=Math.PI/2,i.position.set(n*.6,-.15,6.45),i.castShadow=!o,e.add(i)}this.aircraft.add(e)}setupMouseControls(){this.renderer.domElement.addEventListener("mousedown",o=>{o.button===0&&(this.isFiring=!0)}),window.addEventListener("mouseup",o=>{o.button===0&&(this.isFiring=!1)})}tryFireGuns(e){if(!this.isFiring||!this.aircraft||this.gunBarrels.length===0)return;const o=performance.now()/1e3;o-this.lastShotTime<this.fireInterval||(this.lastShotTime=o,this.forwardVec.set(0,0,1).applyEuler(new Me(this.inputState.pitch,this.inputState.yaw,this.inputState.roll)).normalize(),this.gunBarrels.forEach(t=>{t.getWorldPosition(this.tempVec),this.spawnBullet(this.tempVec,this.forwardVec),this.spawnMuzzleFlash(t)}))}spawnBullet(e,o){const t=new D(.45,10,10),a=new $({color:16773222}),s=new c(t,a);s.position.copy(e),this.scene.add(s),this.bullets.push({mesh:s,velocity:o.clone().multiplyScalar(450),life:2,age:0})}spawnMuzzleFlash(e){const o=new D(.2,8,8),t=new $({color:16768324}),a=new c(o,t);e.getWorldPosition(a.position),this.scene.add(a),this.muzzleFlashes.push({mesh:a,age:0,life:.12})}ensurePlayerName(){const e=localStorage.getItem("skywarriors_playerName");if(e){this.playerName=e;return}this.showNamePrompt()}showNamePrompt(){if(document.getElementById("namePromptOverlay"))return;const e=document.createElement("div");e.id="namePromptOverlay",e.innerHTML=`
<div id="namePromptBox">
  <h2>Enter Player Name</h2>
  <input id="playerNameInput" maxlength="18" placeholder="e.g.: Ace Pilot" />
  <button id="confirmNameBtn">Enter Battle</button>
  <div class="note">This name will be used for the scoreboard and saved locally.
  Leave blank to generate a random name.</div>
</div>`,document.body.appendChild(e),e.querySelector("#confirmNameBtn").addEventListener("click",()=>{const o=e.querySelector("#playerNameInput").value.trim();this.playerName=o||"Pilot_"+Math.random().toString(36).slice(2,7),localStorage.setItem("skywarriors_playerName",this.playerName),e.remove(),this.registerPlayerIfNeeded(),this.updateScoreboardUI()})}loadScores(){try{const e=localStorage.getItem(this.localStorageKey);e&&(this.scoreData=JSON.parse(e))}catch(e){console.warn("Load score error",e)}}saveScores(){try{localStorage.setItem(this.localStorageKey,JSON.stringify(this.scoreData))}catch(e){console.warn("Save score error",e)}}registerPlayerIfNeeded(){this.playerName&&(this.scoreData.players[this.playerName]||(this.scoreData.players[this.playerName]={tank:0,ship:0,total:0,last:Date.now()},this.saveScores()))}recordKill(e){if(!this.playerName)return;const o=this.scoreData.players[this.playerName];o&&(e==="tank"?o.tank+=1:e==="ship"&&(o.ship+=1),o.total=o.tank+o.ship,o.last=Date.now(),this.saveScores(),this.updateScoreboardUI(),e==="tank"?this.sessionKills.tank++:e==="ship"&&this.sessionKills.ship++,this.updateHudStats())}updateScoreboardUI(){const e=document.getElementById("scoreboardPanel");if(!e)return;e.style.display="block";const o=document.getElementById("scoreRows");if(!o)return;const t=Object.entries(this.scoreData.players).map(([n,i])=>({name:n,...i}));t.sort((n,i)=>i.total-n.total||n.name.localeCompare(i.name)),o.innerHTML="",t.forEach((n,i)=>{const r=document.createElement("tr");n.name===this.playerName&&r.classList.add("highlight"),r.innerHTML=`<td>${i+1}</td><td>${n.name}</td><td>${n.tank}</td><td>${n.ship}</td><td>${n.total}</td>`,o.appendChild(r)});const a=document.getElementById("playerNameDisplay");a&&(a.textContent="当前玩家: "+(this.playerName||"--"));const s=document.getElementById("exportScoreBtn");s&&!s.dataset.bound&&(s.dataset.bound="1",s.addEventListener("click",()=>this.exportScoresJSON()))}exportScoresJSON(){const e=new Blob([JSON.stringify(this.scoreData,null,2)],{type:"application/json"}),o=URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download="scores.json",t.click(),URL.revokeObjectURL(o),this.showNotification("已导出积分 JSON","success")}updateHudStats(){const e=document.getElementById("hudStats");if(!e)return;e.style.display="flex";const o=document.getElementById("hudTankKills"),t=document.getElementById("hudShipKills"),a=document.getElementById("hudTotalKills");o&&(o.textContent=this.sessionKills.tank),t&&(t.textContent=this.sessionKills.ship),a&&(a.textContent=this.sessionKills.tank+this.sessionKills.ship)}updateBullets(e){for(let o=this.bullets.length-1;o>=0;o--){const t=this.bullets[o];t.age+=e,t.mesh.position.addScaledVector(t.velocity,e),t.mesh.scale.z=1+t.age*4;const a=t.age/t.life;if(a>.6&&(t.mesh.material.transparent=!0,t.mesh.material.opacity=1-(a-.6)/.4),this.tanks&&this.tanks.length>0)for(let s=0;s<this.tanks.length;s++){const n=this.tanks[s];if(!n.alive)continue;if(t.mesh.position.distanceTo(n.mesh.position)<n.radius){n.health=Math.max(0,n.health-1),this.createExplosion(n.mesh.position.clone().add(new k((Math.random()-.5)*10,5,(Math.random()-.5)*10))),n.health<=0?(n.alive=!1,this.createTankDestroyed(n.mesh.position.clone(),n.mesh),this.createScorchMark(n.mesh.position.x,n.mesh.position.z),this.recordKill("tank"),n.healthBar&&n.healthBar.container.remove()):n.isAA||(this.playerHealth=Math.min(this.playerMaxHealth,this.playerHealth+10)),this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.bullets.splice(o,1);break}}if(this.warships&&this.warships.length>0)for(let s=0;s<this.warships.length;s++){const n=this.warships[s];if(!n.alive)continue;if(t.mesh.position.distanceTo(n.mesh.position)<n.radius){n.health=Math.max(0,n.health-1),this.createExplosion(n.mesh.position.clone().add(new k((Math.random()-.5)*20,8,(Math.random()-.5)*20))),n.health<=0&&(n.alive=!1,this.scene.remove(n.mesh),this.createSeaScorch(n.mesh.position.x,n.mesh.position.z),this.recordKill("ship"),n.healthBar&&n.healthBar.container.remove()),this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.bullets.splice(o,1);break}}t.age>=t.life&&(this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.bullets.splice(o,1))}for(let o=this.muzzleFlashes.length-1;o>=0;o--){const t=this.muzzleFlashes[o];t.age+=e;const a=t.age/t.life;t.mesh.scale.setScalar(1+a*5),t.mesh.material.transparent=!0,t.mesh.material.opacity=1-a,t.age>=t.life&&(this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.muzzleFlashes.splice(o,1))}}createEnemyBullet(e,o,t=400){const a=new D(.45,10,10),s=new $({color:16773222,transparent:!0,opacity:.95}),n=new c(a,s);n.position.copy(e);const i=new k().subVectors(o,e).normalize();this.scene.add(n);const r={mesh:n,velocity:i.multiplyScalar(t),age:0,life:3};return this.enemyBullets.push(r),r}createEnemyMuzzleFlash(e){const o=new D(.2,8,8),t=new $({color:16768324}),a=new c(o,t);a.position.copy(e),this.scene.add(a),this.muzzleFlashes.push({mesh:a,age:0,life:.12})}updateEnemyBullets(e){for(let o=this.enemyBullets.length-1;o>=0;o--){const t=this.enemyBullets[o];t.age+=e,t.mesh.position.addScaledVector(t.velocity,e);const a=t.age/t.life;if(a>.7&&(t.mesh.material.opacity=.9*(1-(a-.7)/.3)),t.mesh.position.distanceTo(this.playerPosition)<15&&this.aircraft){this.playerHealth=Math.max(0,this.playerHealth-2),this.updatePlayerHealthDisplay(),this.createPlayerHitEffect(),this.playerHealth<=0&&this.handlePlayerDeath(),this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.enemyBullets.splice(o,1);continue}t.age>=t.life&&(this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.enemyBullets.splice(o,1))}}createPlayerHitEffect(){const e=document.createElement("div");e.style.cssText=`
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: radial-gradient(circle, rgba(255,0,0,0.3) 0%, transparent 50%);
                    pointer-events: none; z-index: 9999;
                `,document.body.appendChild(e),setTimeout(()=>{e.remove()},150)}handlePlayerDeath(){const e=document.createElement("div");e.style.cssText=`
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
                    display: flex; flex-direction: column; justify-content: center; align-items: center;
                    z-index: 10000; color: white; font-family: 'Segoe UI', sans-serif;
                `,e.innerHTML=`
                    <h1 style="font-size: 48px; margin-bottom: 20px; color: #ff4444; text-shadow: 0 0 20px rgba(255, 68, 68, 0.8);">GAME OVER</h1>
                    <p style="font-size: 20px; margin-bottom: 30px;">Your aircraft was shot down!</p>
                    <button onclick="location.reload()" style="
                        padding: 12px 30px; font-size: 18px; background: linear-gradient(135deg, #ff4444, #cc3333);
                        border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;
                        box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3); transition: transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        Restart Game
                    </button>
                `,document.body.appendChild(e)}calculateLeadTarget(e,o,t,a,s){const i=e.distanceTo(o)/a,r=o.clone().addScaledVector(t,i),l=(1-s)*100;return r.add(new k((Math.random()-.5)*l,(Math.random()-.5)*l*.5,(Math.random()-.5)*l)),r}createWarships(e=5){for(let o=0;o<e;o++){const t=(Math.random()-.5)*6500,a=(Math.random()-.5)*6500;if(Math.hypot(t,a)<600){o--;continue}const s=this.createWarship(t,a);this.warships.push(s)}}createWarship(e,o){const t=new z,a=160+Math.random()*60,s=22+Math.random()*6,n=10,i=new H(s,n,a,8,1,16),r=i.attributes.position;for(let b=0;b<r.count;b++){const N=r.getZ(b),B=Math.abs(N)/(a/2),I=1-Math.pow(B,1.4);r.setX(b,r.getX(b)*(.55+.45*I)),r.setY(b,r.getY(b)*(.55+.45*I))}i.computeVertexNormals();const l=new y({color:4146508,metalness:.25,roughness:.85}),d=new c(i,l);d.position.y=-41,d.castShadow=!0,d.receiveShadow=!0,t.add(d);const h=new c(new H(s*.9,4,a*.62),new y({color:6778229,metalness:.25,roughness:.6}));h.position.set(0,-36.2,0),h.castShadow=!0,t.add(h);const m=new c(new H(s*.4,14,a*.18),new y({color:8028296}));m.position.set(0,h.position.y+9,-a*.08),m.castShadow=!0,t.add(m);const u=new c(new w(.5,.5,6,12),new y({color:14277081}));u.position.set(0,m.position.y+10,-a*.08),u.rotation.x=Math.PI/2,t.add(u);const p=7,g=new c(new w(.6,.8,p,10),new y({color:14540253,metalness:.4,roughness:.5}));g.position.set(0,h.position.y+p/2+2,0),g.castShadow=!0,t.add(g);const C=new z,R=new $({color:16720418}),A=new c(new _(3.2,9,18),R);A.rotation.x=Math.PI,C.add(A);const T=new c(new w(.45,.45,4.5,12),R);T.position.y=-6.5,C.add(T),C.position.set(0,h.position.y+18,0),C.userData={pulsePhase:Math.random()*Math.PI*2},t.add(C);const v=new y({color:5988456,metalness:.3,roughness:.6}),V=new w(6,6,4,12),L=new c(V,v);L.position.set(0,h.position.y+3,a*.18),L.castShadow=!0,t.add(L);const O=new c(V,v);O.position.set(0,h.position.y+3,-a*.25),O.castShadow=!0,t.add(O);const Y=new w(.7,.9,18,12);[L,O].forEach((b,N)=>{for(let B=0;B<2;B++){const I=new c(Y,new y({color:3816770,metalness:.5,roughness:.4}));I.rotation.x=Math.PI/2,I.position.set(B===0?-1.2:1.2,b.position.y,b.position.z+(N===0?8:-8)),I.position.y+=2,t.add(I)}}),t.position.set(e,0,o),this.scene.add(t);const W=this.createHealthBar(),q=6;return{mesh:t,alive:!0,radius:s*2,indicator:C,health:q,maxHealth:q,healthBar:W,lastShotTime:0,shootingRange:1e3,fireRate:3+Math.random()*2,accuracy:.4+Math.random()*.2}}createSeaScorch(e,o){const t=18+Math.random()*12,a=new ce(t,22),s=new $({color:0,transparent:!0,opacity:.25}),n=new c(a,s);n.rotation.x=-Math.PI/2,n.position.set(e,-39.9,o),this.scene.add(n),setTimeout(()=>{this.scene.remove(n),a.dispose(),s.dispose()},8e3)}createTrees(){const e=this.environmentConfig.treeDensityMultiplier;this.createDenseForest(-2500,-2e3,800,600,"pine",Math.round(80*e)),this.createDenseForest(1800,1500,700,500,"oak",Math.round(70*e)),this.createMediumForest(-1e3,2200,900,700,"mixed",Math.round(45*e)),this.createMediumForest(2200,-800,600,800,"birch",Math.round(40*e)),this.createSparseForest(-3e3,0,1200,800,"oak",Math.round(25*e)),this.createSparseForest(0,-2800,1e3,600,"pine",Math.round(20*e)),this.createSparseForest(1e3,3e3,800,600,"palm",Math.round(15*e));for(let o=0;o<Math.round(100*e);o++){const t=(Math.random()-.5)*7e3,a=(Math.random()-.5)*7e3,s=["pine","oak","birch","palm"][Math.floor(Math.random()*4)];this.createTree(t,a,s)}}createDenseForest(e,o,t,a,s,n){for(let i=0;i<n;i++){const r=e+(Math.random()-.5)*t*.8,l=o+(Math.random()-.5)*a*.8,d=(Math.random()-.5)*50,h=(Math.random()-.5)*50;this.createTree(r+d,l+h,s)}}createMediumForest(e,o,t,a,s,n){for(let i=0;i<n;i++){const r=e+(Math.random()-.5)*t,l=o+(Math.random()-.5)*a;Math.random()>.3&&this.createTree(r,l,s)}}createSparseForest(e,o,t,a,s,n){for(let i=0;i<n;i++){const r=e+(Math.random()-.5)*t,l=o+(Math.random()-.5)*a;Math.random()>.6&&this.createTree(r,l,s)}}createLakes(){[{x:-1500,z:-1200,radius:350,color:3835837},{x:1200,z:800,radius:250,color:3505850},{x:400,z:-1400,radius:180,color:3108783},{x:-800,z:1600,radius:200,color:3374005},{x:1800,z:-600,radius:150,color:3044778}].forEach(o=>this.createLake(o.x,o.z,o.radius,o.color));for(let o=0;o<6;o++){const t=(Math.random()-.5)*6e3,a=(Math.random()-.5)*6e3,s=80+Math.random()*140;this.createLake(t,a,s,3108783)}}createLake(e,o,t,a){const n=new ce(t,48),i=n.attributes.position;for(let h=0;h<i.count;h++){if(h===0)continue;const m=i.getX(h),u=i.getY(h),p=1+(Math.random()-.5)*.15;i.setX(h,m*p),i.setY(h,u*p)}i.needsUpdate=!0,n.computeVertexNormals();const r=new S({color:a,transparent:!0,opacity:.9,side:Se}),l=new c(n,r);l.rotation.x=-Math.PI/2,l.position.set(e,-46,o),l.receiveShadow=!0,this.scene.add(l);const d=Math.floor(t/20);for(let h=0;h<d;h++){const m=Math.random()*Math.PI*2,u=t+30+Math.random()*120,p=e+Math.cos(m)*u,g=o+Math.sin(m)*u,C=["birch","oak","pine"];this.createTree(p,g,C[Math.floor(Math.random()*C.length)])}}createTree(e,o,t="oak"){const a=new z;if(this.sceneType==="ocean"){const i=t==="palm"?30:22,r=i*.7,l=i+Math.random()*(t==="palm"?18:10),d=8+Math.random()*4,h=new w(r,l,d,24,1,!1);h.translate(0,d/2,0);const m=new le().setHSL(.12+Math.random()*.04,.55,.62),u=new c(h,new S({color:m}));u.position.set(e,-50,o),u.castShadow=!0,u.receiveShadow=!0,u.userData.isIsland=!0;const p=new w(r*1.05,r*1.25,1.2,24,1,!1),g=new c(p,new S({color:16115617}));g.position.y=d+-50-.4,g.receiveShadow=!0,u.add(g),this.scene.add(u)}let s,n;switch(t){case"pine":s=15+Math.random()*10,n=.6+Math.random()*.3;const i=new w(n*.7,n*1.2,s,8),r=new S({color:9127187}),l=new c(i,r);l.position.y=s/2-50,l.castShadow=!0,a.add(l);const d=[1003279,2263842,3329330,9498256];for(let b=0;b<5;b++){const N=5-b*.7,B=3.5+Math.random()*.5,I=new _(N,B,8),Z=new S({color:d[Math.min(b,3)]}),M=new c(I,Z);M.position.y=s-50+b*2.8,M.castShadow=!0,a.add(M)}break;case"oak":s=10+Math.random()*8,n=1.2+Math.random()*.6;const h=new w(n*.8,n*1.4,s,8),m=new S({color:6636321}),u=new c(h,m);u.position.y=s/2-50,u.castShadow=!0,a.add(u);const p=new D(6+Math.random()*2,10,8);p.scale(1.4,.9,1.4);const g=new S({color:2263842}),C=new c(p,g);C.position.y=s-50+4,C.castShadow=!0,a.add(C);for(let b=0;b<3;b++){const N=new D(2+Math.random(),8,6),B=new S({color:3329330}),I=new c(N,B);I.position.set((Math.random()-.5)*8,s-50+3+Math.random()*3,(Math.random()-.5)*8),I.castShadow=!0,a.add(I)}break;case"birch":s=12+Math.random()*6,n=.4+Math.random()*.2;const R=new w(n*.9,n*1.1,s,8),A=new S({color:16119260}),T=new c(R,A);T.position.y=s/2-50,T.castShadow=!0,a.add(T);const v=new D(4+Math.random()*1.5,8,6);v.scale(1.2,1.4,1.2);const V=new S({color:10145074}),L=new c(v,V);L.position.y=s-50+3,L.castShadow=!0,a.add(L);break;case"palm":s=14+Math.random()*8,n=.8;const O=new w(n*.6,n,s,8),Y=new S({color:13789470}),W=new c(O,Y);W.position.y=s/2-50,W.rotation.z=(Math.random()-.5)*.4,W.castShadow=!0,a.add(W);for(let b=0;b<12;b++){const N=new w(.1,.4,7,4),B=new S({color:2263842}),I=new c(N,B),Z=b/12*Math.PI*2,M=2.5+Math.random()*.5;I.position.set(Math.cos(Z)*M,s-50+3,Math.sin(Z)*M),I.rotation.z=Z+Math.PI/2.5,I.rotation.x=(Math.random()-.5)*.3,I.castShadow=!0,a.add(I)}break;case"mixed":const q=["pine","oak","birch"];return this.createTree(e,o,q[Math.floor(Math.random()*q.length)])}a.rotation.y=Math.random()*Math.PI*2,a.position.set(e,0,o),this.scene.add(a)}createBushCluster(e,o,t=8){for(let a=0;a<t;a++){const s=2+Math.random()*2.5,n=new D(s,8,6),i=new le().setHSL(.28+Math.random()*.08,.6,.35+Math.random()*.2),r=new S({color:i}),l=new c(n,r),d=Math.random()*Math.PI*2,h=Math.random()*8;l.position.set(e+Math.cos(d)*h,-50+s*.5,o+Math.sin(d)*h),l.castShadow=!0,this.scene.add(l)}}createRocks(e){for(let o=0;o<e;o++){const t=3+Math.random()*10,a=new Qe(t,0),s=new le().setHSL(.08+Math.random()*.05,.2,.25+Math.random()*.2),n=new S({color:s}),i=new c(a,n);i.position.set((Math.random()-.5)*7600,-50+t*.5,(Math.random()-.5)*7600),i.rotation.y=Math.random()*Math.PI*2,i.castShadow=!0,this.scene.add(i)}}createGrassPatches(e){for(let o=0;o<e;o++){const t=new z,a=(Math.random()-.5)*7600,s=(Math.random()-.5)*7600,n=4+Math.random()*6;for(let i=0;i<n;i++){const r=4+Math.random()*6,l=new w(.05,.25,r,4,1),d=new S({color:3968286}),h=new c(l,d);h.position.set((Math.random()-.5)*3,-50+r/2,(Math.random()-.5)*3),h.rotation.x=(Math.random()-.5)*.4,h.rotation.z=(Math.random()-.5)*.4,t.add(h)}t.position.set(a,0,s),this.scene.add(t)}}createBirdFlock(){const e=new z,o=12+Math.floor(Math.random()*8);for(let t=0;t<o;t++){const a=new _(1.2,3,4),s=new $({color:2236962}),n=new c(a,s);n.rotation.x=Math.PI/2,n.position.set((Math.random()-.5)*30,(Math.random()-.5)*10,(Math.random()-.5)*30),e.add(n)}e.position.set((Math.random()-.5)*6e3,150+Math.random()*250,(Math.random()-.5)*6e3),e.userData={speed:20+Math.random()*15,dir:new k(Math.random()-.5,0,Math.random()-.5).normalize()},this.scene.add(e),this.flocks||(this.flocks=[]),this.flocks.push(e)}updateFlocks(e){this.flocks&&this.flocks.forEach(o=>{o.position.addScaledVector(o.userData.dir,o.userData.speed*e),o.position.y+=Math.sin(Date.now()*.001+o.position.x*.01)*.2;const t=4e3;o.position.x>t&&(o.position.x=-t),o.position.x<-t&&(o.position.x=t),o.position.z>t&&(o.position.z=-t),o.position.z<-t&&(o.position.z=t)})}createSoilPatches(e){for(let o=0;o<e;o++){const t=40+Math.random()*120,a=new ce(t,24),s=a.attributes.position;for(let l=0;l<s.count;l++){if(l===0)continue;const d=s.getX(l),h=s.getY(l),m=1+(Math.random()-.5)*.25;s.setX(l,d*m),s.setY(l,h*m)}s.needsUpdate=!0;const n=[8085041,7031327,10515783,9069109],i=new S({color:n[Math.floor(Math.random()*n.length)],side:Se,opacity:.92,transparent:!0}),r=new c(a,i);r.rotation.x=-Math.PI/2,r.position.set((Math.random()-.5)*7600,-49.9,(Math.random()-.5)*7600),r.receiveShadow=!0,this.scene.add(r)}}getGroundHeight(e,o){if(!this.ground)return-50;this.raycaster.set(new k(e,500,o),new k(0,-1,0));const t=this.raycaster.intersectObject(this.ground,!1);return t.length?t[0].point.y:-50}alignTankToGround(e){const a=this.getGroundHeight(e.position.x,e.position.z)+4- -50;e.position.y=a}createTanks(e=10){for(let o=0;o<e;o++){const t=(Math.random()-.5)*7e3,a=(Math.random()-.5)*7e3;if(Math.hypot(t,a)<400){o--;continue}const s=this.createTank(t,a);this.tanks.push(s)}this.tanks.forEach(o=>this.alignTankToGround(o.mesh))}createTank(e,o){const t=new z,a=[5069364,5597999,7232302,6054195],s=a[Math.floor(Math.random()*a.length)],n=new y({color:s,metalness:.25,roughness:.75}),i=24,r=8,l=46,d=new c(new H(i,r,l),n);d.position.y=-50+r/2,d.castShadow=!0,d.receiveShadow=!0,t.add(d);const h=new y({color:1907997,roughness:.95});for(let M of[-1,1]){const K=new c(new H(4,r-1.8,l),h);K.position.set(M*(i/2+3.2),-50+(r-1.8)/2,0),K.castShadow=!0,t.add(K)}const m=new w(2.4,2.4,1.4,18),u=new y({color:3815994,metalness:.4,roughness:.6}),p=[-14,-7,0,7,14];for(let M of[-1,1])p.forEach(K=>{const U=new c(m,u);U.rotation.z=Math.PI/2,U.position.set(M*(i/2+3.2),-50+1.6,K),t.add(U)});const g=9,C=new c(new w(10,10,g,24),n),R=-50+2.5+2.5+g/2;C.position.set(0,R,0),C.castShadow=!0,C.receiveShadow=!0,t.add(C);const A=new w(2,2,2,24),T=new y({color:s}),v=new c(A,T);v.position.set(0,R+g/2+1,0),v.castShadow=!0,v.receiveShadow=!0,t.add(v);const V=Math.random()<.3;if(V){const M=new z;M.position.set(0,R+g/2*.2,0);const K=new c(new w(2.4,2.6,2.2,16),new y({color:s*.9,metalness:.4,roughness:.6}));K.castShadow=!0,M.add(K);const U=new y({color:2236962,metalness:.55,roughness:.35}),X=new w(.35,.35,17,10),J=new w(.18,.18,.9,10);[[-.9,.5],[.9,.5],[-.9,-.5],[.9,-.5]].forEach(([ne,ie])=>{const Q=new c(X,U);Q.rotation.x=Math.PI/2,Q.position.set(ne,ie,6.5+1.5),Q.castShadow=!0,M.add(Q);const oe=new c(J,U);oe.rotation.x=Math.PI/2,oe.position.set(ne,ie,13.2+1.5),M.add(oe)}),M.rotation.x=-se.degToRad(10),t.add(M),t.userData.aa=!0}else{const M=new z;M.name="gunPivot",M.position.set(0,R,0),t.add(M);const K=new y({color:2960685,metalness:.6,roughness:.45}),U=26,X=new c(new w(.6,.85,U,18),K);X.rotation.x=Math.PI/2,X.position.z=U/2+2,M.add(X);const J=new c(new w(.4,.4,2,12),new y({color:328965,metalness:.3,roughness:.9}));J.rotation.x=Math.PI/2,J.position.z=U+2,M.add(J),M.rotation.x=-se.degToRad(35)}const L=new z,O=new $({color:16720418}),Y=new c(new _(3.2,9,18),O);Y.rotation.x=Math.PI,L.add(Y);const W=new c(new w(.45,.45,4.5,12),O);W.position.y=-6.5,L.add(W),L.position.set(0,R+12,0),L.userData={pulsePhase:Math.random()*Math.PI*2},t.add(L),t.position.set(e,0,o),this.alignTankToGround(t),this.scene.add(t);const q=this.createHealthBar(),b=15+Math.random()*10,N=Math.random()*Math.PI*2,B=(Math.random()-.5)*.3,I=V,Z=I?4:3;return{mesh:t,alive:!0,radius:16,indicator:L,health:Z,maxHealth:Z,healthBar:q,isAA:I,velocity:new k,moveDirection:N,moveSpeed:b,turretRotation:Math.random()*Math.PI*2,turretSpeed:B,changeDirectionTimer:Math.random()*8,turretReference:C,lastShotTime:0,shootingRange:600,fireRate:2+Math.random()*1.5,accuracy:.5+Math.random()*.2}}updateTanks(e){if(!this.tanks)return;this.tankUpdateCounter=(this.tankUpdateCounter||0)+1;const o=this.tankUpdateCounter%3===0;this.tanks.forEach((t,a)=>{if(!t.alive||(t.turretReference&&(t.turretRotation+=t.turretSpeed*e,t.turretReference.rotation.y=t.turretRotation),!o))return;if(t.changeDirectionTimer-=e*3,t.changeDirectionTimer<=0){const l=Math.PI/2+Math.random()*Math.PI/2;t.moveDirection+=Math.random()>.5?l:-l,t.changeDirectionTimer=4+Math.random()*6}t.velocity.set(Math.cos(t.moveDirection)*t.moveSpeed,0,Math.sin(t.moveDirection)*t.moveSpeed);const s=e*3;t.mesh.position.x+=t.velocity.x*s,t.mesh.position.z+=t.velocity.z*s;const n=3500,i=t.mesh.position;if((Math.abs(i.x)>n||Math.abs(i.z)>n)&&(t.moveDirection+=Math.PI,t.changeDirectionTimer=1+Math.random()*2),(this.tankUpdateCounter+a)%15===0&&this.alignTankToGround(t.mesh),t.mesh.rotation.y=t.moveDirection,t.isAA&&t.alive){const l=performance.now()/1e3;if(l-t.lastShotTime>t.fireRate&&t.mesh.position.distanceTo(this.playerPosition)<t.shootingRange){const m=this.calculateLeadTarget(t.mesh.position,this.playerPosition,this.playerVelocity,400,t.accuracy),u=t.mesh.position.clone();if(u.y+=10,this.createEnemyBullet(u,m),this.createEnemyMuzzleFlash(u),t.lastShotTime=l,t.turretReference){const p=new k().subVectors(m,t.mesh.position).normalize();t.turretReference.rotation.y=Math.atan2(p.x,p.z)}}}})}updateWarships(e){if(!this.warships)return;const o=performance.now()/1e3;this.warships.forEach((t,a)=>{if(!t.alive)return;if(o-t.lastShotTime>t.fireRate&&t.mesh.position.distanceTo(this.playerPosition)<t.shootingRange){const i=this.calculateLeadTarget(t.mesh.position,this.playerPosition,this.playerVelocity,350,t.accuracy),r=t.mesh.position.clone();r.y+=25,this.createEnemyBullet(r,i,350),this.createEnemyMuzzleFlash(r),t.lastShotTime=o}})}updateTankIndicators(e){const o=performance.now()*.001;this.tanks&&this.tanks.forEach(t=>{if(!t.alive){t.indicator&&(t.indicator.visible=!1);return}if(t.indicator){t.indicator.visible=!0,t.indicator.lookAt(this.camera.position);const a=o*4+(t.indicator.userData.pulsePhase||0),s=1+Math.sin(a)*.25;t.indicator.scale.set(s,s,s)}}),this.warships&&this.warships.forEach(t=>{if(!t.alive){t.indicator&&(t.indicator.visible=!1);return}if(t.indicator){t.indicator.visible=!0,t.indicator.lookAt(this.camera.position);const a=o*4+(t.indicator.userData.pulsePhase||0),s=1+Math.sin(a)*.25;t.indicator.scale.set(s,s,s)}})}createExplosion(e){const o=new z;o.position.copy(e),this.scene.add(o);const t=26;for(let s=0;s<t;s++){const n=.9+Math.random()*1.4,i=new D(n,6,6),r=16753971,l=new $({color:r,transparent:!0,opacity:1}),d=new c(i,l);d.userData={dir:new k(0,0,0),life:.65+Math.random()*.5,age:0,flame:!0};const h=Math.random()*Math.PI*2,m=Math.random()*3.2;d.position.set(Math.cos(h)*m,Math.random()*2,Math.sin(h)*m),o.add(d)}for(let s=0;s<12;s++){const n=new D(2+Math.random()*2.5,8,6),i=new $({color:2829099,transparent:!0,opacity:.55}),r=new c(n,i);r.userData={dir:new k(0,.15+Math.random()*.25,0),life:2.2+Math.random()*.8,age:0,smoke:!0};const l=Math.random()*Math.PI*2,d=Math.random()*2.5;r.position.set(Math.cos(l)*d,.4+Math.random()*1.2,Math.sin(l)*d),o.add(r)}const a=()=>{o.children.forEach(n=>{if(!n.userData)return;n.userData.age+=.016;const i=n.userData.age/n.userData.life;n.userData.smoke&&n.position.add(n.userData.dir.clone().multiplyScalar(.016)),n.material&&(n.userData.flame?(n.material.opacity=Math.max(0,1-i*1.2),n.scale.multiplyScalar(1+.016*.8)):n.userData.smoke&&(n.material.opacity=Math.max(0,.55*(1-i)),n.scale.multiplyScalar(1+.016*.35)))});for(let n=o.children.length-1;n>=0;n--){const i=o.children[n];i.userData&&i.userData.age>=i.userData.life&&(o.remove(i),i.geometry.dispose(),i.material.dispose())}o.children.length>0?requestAnimationFrame(a):this.scene.remove(o)};a()}createHealthBar(){const e=document.createElement("div");e.className="health-bar-container",e.style.display="none";const o=document.createElement("div");o.className="health-bar-bg";const t=document.createElement("div");t.className="health-bar-fill",t.style.width="100%";const a=document.createElement("div");return a.className="health-bar-text",o.appendChild(t),e.appendChild(o),e.appendChild(a),document.body.appendChild(e),{container:e,fill:t,text:a}}updateHealthBar(e,o){if(!e.health||!e.healthBar||!e.alive)return;const{container:t,fill:a,text:s}=e.healthBar,n=e.mesh.position.clone();n.y+=25;const i=n.clone();if(i.project(o),i.z>1||i.x<-1||i.x>1||i.y<-1||i.y>1){t.style.display="none";return}const r=(i.x*.5+.5)*window.innerWidth,l=(i.y*-.5+.5)*window.innerHeight;t.style.left=r+"px",t.style.top=l+"px",t.style.display="block";const d=e.health/e.maxHealth*100;a.style.width=d+"%",d>66?a.style.background="linear-gradient(90deg, #44ff44, #88ff88)":d>33?a.style.background="linear-gradient(90deg, #ffaa00, #ffdd44)":a.style.background="linear-gradient(90deg, #ff4444, #ff7777)",s.textContent=`${e.health}/${e.maxHealth}`}updateHealthBars(){this.tanks&&this.tanks.length>0&&this.tanks.forEach(e=>{e.alive&&e.healthBar&&e.health<e.maxHealth?this.updateHealthBar(e,this.camera):e.healthBar&&(e.healthBar.container.style.display="none")}),this.warships&&this.warships.length>0&&this.warships.forEach(e=>{e.alive&&e.healthBar&&e.health<e.maxHealth?this.updateHealthBar(e,this.camera):e.healthBar&&(e.healthBar.container.style.display="none")})}createScorchMark(e,o){const t=18+Math.random()*6,a=new ce(t,20),s=new $({color:1907482,transparent:!0,opacity:.55,side:Se}),n=new c(a,s);n.rotation.x=-Math.PI/2,n.position.set(e,-49.8,o),this.scene.add(n);const i=performance.now(),r=()=>{const l=(performance.now()-i)/8e3;l<1?(s.opacity=.55*(1-l),requestAnimationFrame(r)):(this.scene.remove(n),a.dispose(),s.dispose())};requestAnimationFrame(r)}createTankDestroyed(e,o){try{if(!e||!o){console.warn("Invalid tank destruction parameters");return}this.convertTankToWreck(o),this.createExplosionSmoke(e)}catch(t){console.error("Tank destruction error:",t)}}convertTankToWreck(e){try{e.traverse(o=>{if(o.isMesh&&o.material){const t=new y({color:2761762,metalness:.1,roughness:.9});o.material=t}o.name==="gunPivot"&&(o.rotation.x=-Math.PI/6)}),e.rotation.z+=(Math.random()-.5)*.1,e.rotation.x+=(Math.random()-.5)*.08}catch(o){console.warn("Tank wreck conversion error:",o)}}createExplosionSmoke(e){const o=new z;for(let t=0;t<2;t++){const a=new D(1.2,4,3),s=new $({color:3355443,transparent:!0,opacity:.6}),n=new c(a,s);n.position.set(e.x+(Math.random()-.5)*3,e.y+1+t,e.z+(Math.random()-.5)*3),n.scale.setScalar(.4),o.add(n)}this.scene.add(o),setTimeout(()=>{try{this.scene.remove(o),o.children.forEach(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),o.clear()}catch(t){console.warn("Smoke cleanup error:",t)}},2e3)}createBuildings(){this.createTownArea(-800,-800,600,600),this.createTownArea(1200,800,400,400),this.createTownArea(-1500,1e3,300,300);for(let e=0;e<50;e++){const o=(Math.random()-.5)*6e3,t=(Math.random()-.5)*6e3;this.createRandomBuilding(o,t)}}createTownArea(e,o,t,a){const n=Math.min(t,a)/6;for(let i=0;i<6;i++)for(let r=0;r<6;r++){const l=e+(i-3)*n+(Math.random()-.5)*20,d=o+(r-6/2)*n+(Math.random()-.5)*20;this.createRandomBuilding(l,d,!0)}}createRandomBuilding(e,o,t=!1){const a=new z,s=t?20+Math.random()*30:10+Math.random()*15,n=t?20+Math.random()*30:10+Math.random()*15,i=t?30+Math.random()*80:15+Math.random()*25,r=new H(s,i,n),l=[9139029,10506797,6908265,7833753,14423100],d=new S({color:l[Math.floor(Math.random()*l.length)]}),h=new c(r,d);h.position.y=i/2-50,h.castShadow=!0,h.receiveShadow=!0,a.add(h);const m=new _(Math.max(s,n)*.7,i*.3,4),u=new S({color:9109504}),p=new c(m,u);if(p.position.y=i-50+i*.15,p.rotation.y=Math.PI/4,p.castShadow=!0,a.add(p),t)for(let g=0;g<8;g++){const C=new ge(3,4),R=new S({color:16776960,transparent:!0,opacity:.8}),A=new c(C,R);A.position.set((Math.random()-.5)*s*.8,(Math.random()-.3)*i-50,s/2+.1),a.add(A)}a.position.set(e,0,o),this.scene.add(a)}showAnimationControls(){if(!this.modelAnimations||this.modelAnimations.length===0)return;const e=document.createElement("div");e.id="animationControls",e.style.cssText=`
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    font-family: monospace;
                    z-index: 1000;
                    max-width: 250px;
                `,e.innerHTML=`
                    <h4 style="margin: 0 0 10px 0; color: #00ff00;">✈️ Animation Controls</h4>
                    <div id="animationList"></div>
                    <button id="playAllAnimations" style="margin-top: 10px; width: 100%;">▶️ Play All</button>
                    <button id="stopAllAnimations" style="margin-top: 5px; width: 100%;">⏹️ Stop All</button>
                `;const o=e.querySelector("#animationList");this.modelAnimations.forEach((t,a)=>{const s=document.createElement("div");s.style.cssText="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;",s.innerHTML=`
                        <div style="font-size: 12px; color: #00ffff;">${t.name||`Animation ${a+1}`}</div>
                        <div style="font-size: 10px; color: #888;">Duration: ${t.duration.toFixed(1)}s</div>
                        <button class="playAnim" data-index="${a}" style="font-size: 10px; margin-top: 3px;">▶️ Play</button>
                        <button class="pauseAnim" data-index="${a}" style="font-size: 10px; margin-left: 5px;">⏸️ Pause</button>
                    `,o.appendChild(s)}),e.querySelector("#playAllAnimations").addEventListener("click",()=>{this.activeAnimations.forEach(t=>t.play())}),e.querySelector("#stopAllAnimations").addEventListener("click",()=>{this.activeAnimations.forEach(t=>t.stop())}),e.querySelectorAll(".playAnim").forEach(t=>{t.addEventListener("click",a=>{const s=parseInt(a.target.dataset.index);this.activeAnimations[s]&&this.activeAnimations[s].play()})}),e.querySelectorAll(".pauseAnim").forEach(t=>{t.addEventListener("click",a=>{const s=parseInt(a.target.dataset.index);this.activeAnimations[s]&&(this.activeAnimations[s].paused=!this.activeAnimations[s].paused)})}),document.body.appendChild(e),setTimeout(()=>{e.parentNode&&(e.style.opacity="0.3")},3e3)}setupFileUpload(){const e=document.getElementById("fileInput"),o=document.getElementById("glbUpload");e.addEventListener("change",t=>{const a=t.target.files[0];a&&this.loadGLBModel(a)}),o.addEventListener("dragover",t=>{t.preventDefault(),o.style.borderColor="#4CAF50",o.style.backgroundColor="rgba(76, 175, 80, 0.1)"}),o.addEventListener("dragleave",t=>{t.preventDefault(),o.style.borderColor="",o.style.backgroundColor=""}),o.addEventListener("drop",t=>{t.preventDefault(),o.style.borderColor="",o.style.backgroundColor="";const a=t.dataTransfer.files;if(a.length>0){const s=a[0];s.name.toLowerCase().endsWith(".glb")||s.name.toLowerCase().endsWith(".gltf")?this.loadGLBModel(s):this.showNotification("Please drop a GLB or GLTF file","error")}})}loadGLBModel(e){this.showNotification("Loading aircraft model...","success");const o=new Le,t=URL.createObjectURL(e);o.load(t,a=>{this.loadedModel?(this.scene.remove(this.loadedModel),this.modelAnimationMixer&&(this.modelAnimationMixer.stopAllAction(),this.modelAnimationMixer=null)):this.aircraft&&this.scene.remove(this.aircraft);const s=a.scene;this.modelAnimations=a.animations,this.modelAnimationMixer=null,this.activeAnimations=[],a.animations&&a.animations.length>0?(this.modelAnimationMixer=new Ee(s),console.log(`Found ${a.animations.length} animations:`,a.animations.map(m=>m.name)),a.animations.forEach((m,u)=>{const p=this.modelAnimationMixer.clipAction(m);p.setLoop(Ae),p.clampWhenFinished=!1;const g=m.name.toLowerCase();g.includes("propeller")||g.includes("rotor")||g.includes("engine")||g.includes("fan")||g.includes("spin")?(p.timeScale=2,p.play(),this.activeAnimations.push(p),console.log(`Auto-playing fast animation: ${m.name}`)):g.includes("idle")||g.includes("loop")||m.duration>10?(p.timeScale=1,p.play(),this.activeAnimations.push(p),console.log(`Auto-playing slow animation: ${m.name}`)):(p.timeScale=1,p.play(),this.activeAnimations.push(p),console.log(`Auto-playing animation: ${m.name}`))}),this.showNotification(`Aircraft loaded with ${a.animations.length} animations!`,"success")):this.showNotification("Aircraft loaded (no animations found)","success");const i=new Ie().setFromObject(s).getSize(new k),r=18,l=Math.max(i.x,i.y,i.z),d=r/l,h=Math.max(d,15)*1.5;if(s.scale.set(h,h,h),s.traverse(m=>{m.isMesh&&(m.castShadow=!0,m.receiveShadow=!0,m.material&&(Array.isArray(m.material)?m.material.forEach(u=>{this.enhanceMaterial(u)}):this.enhanceMaterial(m.material)))}),s.position.copy(this.playerPosition),this.loadedModel=s,this.aircraft=s,this.scene.add(s),this.createNoseCannons(),a.animations&&a.animations.length>0){const m=document.getElementById("animationControls");m&&m.remove(),setTimeout(()=>this.showAnimationControls(),500)}URL.revokeObjectURL(t)},void 0,a=>{console.error("Error loading GLB model:",a),this.showNotification("Failed to load aircraft model","error"),URL.revokeObjectURL(t)})}enhanceMaterial(e){if(e.color&&e.color.r+e.color.g+e.color.b<.3&&e.color.multiplyScalar(1.5),e.metalness!==void 0&&(e.metalness=Math.min(e.metalness+.2,.6)),e.roughness!==void 0&&(e.roughness=Math.max(e.roughness-.1,.4)),e.envMapIntensity!==void 0&&(e.envMapIntensity=1),e.needsUpdate=!0,e.color&&e.color.getHSL({}).l<.15){const o=e.color.getHSL({});e.color.setHSL(o.h,o.s,Math.max(o.l,.2))}}setupKeyboardControls(){document.addEventListener("keydown",e=>{this.inputState.keys.add(e.code),e.code==="KeyC"&&this.switchCameraView()}),document.addEventListener("keyup",e=>{this.inputState.keys.delete(e.code)})}switchCameraView(){this.currentViewIndex=(this.currentViewIndex+1)%this.viewModes.length;const e=this.viewModes[this.currentViewIndex];this.showViewChangeNotification(e.name)}showViewChangeNotification(e){const o=document.getElementById("viewChangeNotification");o&&o.remove();const t=document.createElement("div");t.id="viewChangeNotification",t.style.cssText=`
                    position: fixed; top: 120px; right: 20px; z-index: 1500;
                    background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(6px);
                    color: white; padding: 8px 16px; border-radius: 6px;
                    font-family: 'Segoe UI', sans-serif; font-size: 14px; font-weight: 600;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    animation: slideInFade 0.3s ease-out;
                `,t.textContent=`📷 ${e}`,document.body.appendChild(t),setTimeout(()=>{t.style.opacity="0",setTimeout(()=>t.remove(),300)},2e3)}updateInputFromKeyboard(e){const o=this.inputState.keys,t=1.5,a=1,s=.8;if((o.has("KeyA")||o.has("ArrowLeft"))&&(this.inputState.yaw+=t*e),(o.has("KeyD")||o.has("ArrowRight"))&&(this.inputState.yaw-=t*e),(o.has("KeyW")||o.has("ArrowUp"))&&(this.inputState.pitch=Math.min(this.inputState.pitch+a*e,Math.PI/4)),(o.has("KeyS")||o.has("ArrowDown"))&&(this.inputState.pitch=Math.max(this.inputState.pitch-a*e,-Math.PI/4)),o.has("KeyQ"))this.inputState.roll-=t*e;else if(o.has("KeyE"))this.inputState.roll+=t*e;else{const i=(this.inputState.roll%(Math.PI*2)+Math.PI*2)%(Math.PI*2);let r=0;i>Math.PI&&(r=Math.PI*2),Math.abs(i-r)<Math.PI/6&&(Math.abs(this.inputState.roll)>.01?this.inputState.roll=se.lerp(this.inputState.roll,Math.round(this.inputState.roll/(Math.PI*2))*Math.PI*2,e*2):this.inputState.roll=Math.round(this.inputState.roll/(Math.PI*2))*Math.PI*2)}(o.has("ShiftLeft")||o.has("ShiftRight")||o.has("Space"))&&(this.inputState.speed=Math.min(this.inputState.speed+s*e,1)),(o.has("ControlLeft")||o.has("ControlRight")||o.has("KeyX"))&&(this.inputState.speed=Math.max(this.inputState.speed-s*e,.2)),!o.has("KeyW")&&!o.has("KeyS")&&!o.has("ArrowUp")&&!o.has("ArrowDown")&&(Math.abs(this.inputState.pitch)>.01?this.inputState.pitch=se.lerp(this.inputState.pitch,0,e*2):this.inputState.pitch=0),o.has("KeyR")?this.rKeyPressed||(this.toggleWeather(),this.rKeyPressed=!0):this.rKeyPressed=!1}updatePlayer(e){if(!this.aircraft)return;this.updateInputFromKeyboard(e);const t=Math.max(this.inputState.speed*120,30);this.playerSpeed=se.lerp(this.playerSpeed,t,e*2);const a=new k(0,0,1),s=new Me(this.inputState.pitch,this.inputState.yaw,this.inputState.roll);a.applyEuler(s);const n=a.clone().multiplyScalar(this.playerSpeed);if(this.playerVelocity.copy(n),this.playerSpeed>40){const d=Math.min(this.playerSpeed/80,1),m=new k(0,1,0).multiplyScalar(d*25*e);this.playerVelocity.add(m)}const i=new k(0,-30,0);this.playerVelocity.add(i.multiplyScalar(e)),this.playerVelocity.multiplyScalar(1-.1*e),this.playerPosition.add(this.playerVelocity.clone().multiplyScalar(e));const r=4e3;let l=!1;this.playerPosition.x>r?(this.playerPosition.x=-r+1,l=!0):this.playerPosition.x<-r&&(this.playerPosition.x=r-1,l=!0),this.playerPosition.z>r?(this.playerPosition.z=-r+1,l=!0):this.playerPosition.z<-r&&(this.playerPosition.z=r-1,l=!0),l&&this.showWrapMessage(),this.playerPosition.y<10&&(this.playerPosition.y=10,this.playerVelocity.y=Math.max(this.playerVelocity.y,0),this.playerVelocity.multiplyScalar(.7)),this.aircraft.position.copy(this.playerPosition),this.aircraft.rotation.set(this.inputState.pitch,this.inputState.yaw,this.inputState.roll),this.updatePropeller(e)}updateCamera(){if(!this.aircraft)return;const e=this.viewModes[this.currentViewIndex],o=new Me(this.inputState.pitch,this.inputState.yaw,this.inputState.roll),t=new et().makeRotationFromEuler(o);let a;this.currentViewIndex===0?a=e.offset.clone().applyMatrix4(t):a=e.offset.clone();const s=this.playerPosition.clone().add(a);this.camera.position.lerp(s,.1);let n;if(this.currentViewIndex===3){const i=new k(0,0,1).applyMatrix4(t);n=this.playerPosition.clone().add(i.multiplyScalar(30))}else n=this.playerPosition.clone();this.camera.lookAt(n)}updateClouds(e){this.clouds.forEach(o=>{o.position.x+=Math.sin(Date.now()*1e-4)*.1,o.rotation.y+=e*.1})}hideLoadingScreen(){const e=document.getElementById("loadingScreen"),o=document.getElementById("progressFill");let t=0;const a=setInterval(()=>{t+=Math.random()*20,t>=100&&(t=100,o.style.width="100%",setTimeout(()=>{e.style.opacity="0",e.style.transition="opacity 1s ease",setTimeout(()=>{e.style.display="none"},1e3)},500),clearInterval(a)),o.style.width=t+"%"},100)}showNotification(e,o="success"){const t=document.getElementById("notification");t.textContent=e,t.className=`notification-${o}`,t.style.display="block",setTimeout(()=>{t.style.display="none"},3e3)}setupSceneSwitcher(){const e=document.getElementById("sceneSwitcher");if(e&&!e.__dynamic&&e.remove(),document.getElementById("sceneSwitcher"))return;const o=document.createElement("div");o.id="sceneSwitcher",o.__dynamic=!0,[{key:"grassland",label:"Grassland"},{key:"snow",label:"Snow"},{key:"desert",label:"Desert"},{key:"ocean",label:"Ocean"}].forEach(a=>{const s=document.createElement("button");s.textContent=a.label,s.dataset.scene=a.key,(this.sceneType===a.key||this.sceneType==="default"&&a.key==="grassland")&&s.classList.add("active"),s.addEventListener("click",()=>{this.sceneType!==a.key&&this.switchSceneType(a.key)}),o.appendChild(s)}),document.body.appendChild(o),window.__SCENE_SWITCHER_VERSION_LOGGED||(window.__SCENE_SWITCHER_VERSION_LOGGED=!0,console.log("[SceneSwitcher] v1 loaded",new Date().toISOString()))}updateSceneSwitcherActive(){const e=document.getElementById("sceneSwitcher");e&&e.querySelectorAll("button").forEach(o=>{o.dataset.scene===this.sceneType?o.classList.add("active"):o.classList.remove("active")})}switchSceneType(e){if(e==="default"&&(e="grassland"),!["grassland","snow","desert","ocean"].includes(e)||this.sceneType===e)return;const t=this.scene,a=this.aircraft,s=this.playerPosition.clone(),n=this.playerVelocity.clone();this.sceneType=e,e==="grassland"?history.replaceState(null,"",window.location.pathname+window.location.search):history.replaceState(null,"","#"+e),this.disposeOldScene(t,a);const i={grassland:8900331,snow:14412277,desert:14860923,ocean:7320319};this.scene=new Ce;const r=i[this.sceneType]||i.grassland;this.scene.fog=new ke(r,100,2e3),this.renderer.setClearColor(r,1),a&&(this.aircraft=a,this.aircraft.position.copy(s),this.scene.add(this.aircraft)),this.tanks=[],this.bullets=[],this.muzzleFlashes=[],this.warships=[],this.gunBarrels=[],this.setupLighting(),this.environmentConfig=this.getEnvironmentConfig(this.sceneType),this.createTerrain(),this.sceneType!=="ocean"&&this.createClouds(),this.createNoseCannons(),this.isFiring&&(this.lastShotTime=0),this.playerPosition.copy(s),this.playerVelocity.copy(n),this.updateSceneSwitcherActive(),this.showNotification("Switched to scene: "+this.sceneType.charAt(0).toUpperCase()+this.sceneType.slice(1),"success")}disposeOldScene(e,o){e&&e.traverse(t=>{o&&(t===o||o.children.includes(t))||t.isMesh&&(t.geometry&&t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(a=>a&&a.dispose&&a.dispose()):t.material&&t.material.dispose())})}gameLoop(){if(this.updatePlayer(.016),this.updateCamera(),this.updateClouds(.016),this.updatePropeller(.016),this.updateTanks(.016),this.updateWarships(.016),this.tryFireGuns(.016),this.updateBullets(.016),this.updateEnemyBullets(.016),this.updateTankIndicators(.016),this.healthBarUpdateCounter=(this.healthBarUpdateCounter||0)+1,this.healthBarUpdateCounter%3===0&&this.updateHealthBars(),this.healthBarUpdateCounter%10===0&&this.updatePlayerHealthDisplay(),this.modelAnimationMixer){const o=this.animationClock.getDelta();this.modelAnimationMixer.update(o)}this.renderer.render(this.scene,this.camera),requestAnimationFrame(()=>this.gameLoop())}updatePropeller(e){this.propeller&&(this.propeller.rotation.z+=30*e)}showWrapMessage(){const e=Date.now();if(e-this.lastWrapMessageTime<3e3)return;this.lastWrapMessageTime=e;const o=["🌍 Entering a new sector...","✈️ Flying to the far side of the world","🗺️ Warping at world boundary...","🌌 Looping world enables endless exploration"],t=o[Math.floor(Math.random()*o.length)],a=document.createElement("div");if(a.textContent=t,a.style.cssText=`
                    position: fixed;
                    top: 20%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: #00ff00;
                    padding: 15px 25px;
                    border-radius: 10px;
                    font-size: 18px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    pointer-events: none;
                    animation: fadeInOut 3s ease-in-out;
                `,!document.querySelector("#wrapMessageStyle")){const s=document.createElement("style");s.id="wrapMessageStyle",s.textContent=`
                        @keyframes fadeInOut {
                            0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                            20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
                        }
                    `,document.head.appendChild(s)}document.body.appendChild(a),setTimeout(()=>{a.parentNode&&a.parentNode.removeChild(a)},3e3)}}new at;
//# sourceMappingURL=index-DpQ2Y43N.js.map
